name: Daily Full Test Suite

on:
  # 每天凌晨 2:00 (UTC) 运行
  schedule:
    - cron: '0 2 * * *'
  
  # 允许手动触发
  workflow_dispatch:
  
  # 也在 main 分支推送时运行（可选）
  push:
    branches:
      - main
      - master

jobs:
  go-tests:
    name: Go Tests (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      
      - name: Install dependencies
        run: go mod download
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Build project
        run: go build -v ./...
      
      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Run benchmark tests
        run: go test -v -bench=. -benchmem ./... | tee benchmark.txt
        continue-on-error: true
      
      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        if: matrix.go-version == '1.22'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.out
          flags: golang
          name: go-coverage
        continue-on-error: true
      
      - name: Upload benchmark results
        if: matrix.go-version == '1.22'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-go${{ matrix.go-version }}
          path: benchmark.txt
          retention-days: 7

  cross-platform-tests:
    name: Cross-Platform Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: go-tests
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go-version: ['1.22']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      
      - name: Install dependencies
        run: go mod download
      
      - name: Build project
        run: go build -v ./...
      
      - name: Run tests
        run: go test -v -race ./...
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            *.out
            *.log
          retention-days: 7

  cross-language-tests:
    name: Cross-Language Integration Tests
    runs-on: ubuntu-latest
    needs: go-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Go dependencies
        run: go mod download
      
      - name: Build Go library
        run: go build -v ./...
      
      - name: Run cross-language tests
        run: |
          cd tests
          go test -v -tags=integration ./...
        timeout-minutes: 30
        continue-on-error: true
      
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            tests/*.log
            tests/*.out
          retention-days: 7

  notify-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: [go-tests, cross-platform-tests, cross-language-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Go Tests: ${{ needs.go-tests.result }}"
          echo "Cross-Platform Tests: ${{ needs.cross-platform-tests.result }}"
          echo "Cross-Language Tests: ${{ needs.cross-language-tests.result }}"
          
          if [ "${{ needs.go-tests.result }}" != "success" ] || \
             [ "${{ needs.cross-platform-tests.result }}" != "success" ]; then
            echo "❌ Some tests failed!"
            exit 1
          else
            echo "✅ All tests passed!"
          fi
