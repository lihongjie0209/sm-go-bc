name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0, v0.1.0

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
      
      - name: Run tests
        run: go test -v -race ./...
      
      - name: Build verification
        run: go build -v ./...
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
            CHANGELOG=$(awk "/## \[${VERSION}\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md || echo "See commit history for changes.")
          else
            # å¦‚æœæ²¡æœ‰ CHANGELOGï¼Œä½¿ç”¨ git log
            CHANGELOG=$(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" || echo "Initial release")
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸš€ Release ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¦ Installation
            
            ```bash
            go get github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}
            ```
            
            ### ğŸ“š Documentation
            
            - [pkg.go.dev](https://pkg.go.dev/github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }})
            - [GitHub Repository](https://github.com/${{ github.repository }})
            
            ### ğŸ“ Changes
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  publish-to-pkg-go-dev:
    name: Publish to pkg.go.dev
    runs-on: ubuntu-latest
    needs: release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Trigger pkg.go.dev indexing
        run: |
          echo "ğŸ”„ Triggering pkg.go.dev indexing for ${{ steps.version.outputs.VERSION }}"
          
          # æ–¹æ³• 1: é€šè¿‡ Go Proxy è§¦å‘
          echo "ğŸ“¡ Requesting from Go Proxy..."
          curl -f -s "https://proxy.golang.org/github.com/${{ github.repository }}/@v/${{ steps.version.outputs.VERSION }}.info" || echo "Proxy request sent"
          
          # æ–¹æ³• 2: ä½¿ç”¨ go get è§¦å‘
          echo "ğŸ“¥ Using go get to trigger indexing..."
          GOPROXY=https://proxy.golang.org,direct go list -m github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}
          
          # æ–¹æ³• 3: è¯·æ±‚ pkg.go.dev API
          echo "ğŸŒ Requesting pkg.go.dev..."
          curl -f -s "https://pkg.go.dev/github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}" > /dev/null || echo "pkg.go.dev request sent"
          
          echo "âœ… Indexing requests sent!"
      
      - name: Wait for indexing
        run: |
          echo "â³ Waiting for pkg.go.dev to index the package..."
          sleep 30
      
      - name: Verify pkg.go.dev availability
        run: |
          echo "ğŸ” Verifying pkg.go.dev availability..."
          
          # æ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡ go get è·å–
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          go mod init test
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            if go get github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}; then
              echo "âœ… Package successfully available!"
              go list -m github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Waiting 30 seconds before retry..."
                sleep 30
              fi
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âš ï¸ Package may not be immediately available. This is normal."
            echo "â„¹ï¸ It may take up to 30 minutes for pkg.go.dev to index the package."
          fi
      
      - name: Post release info
        run: |
          echo "ğŸ‰ Release complete!"
          echo ""
          echo "ğŸ“¦ Package: github.com/${{ github.repository }}"
          echo "ğŸ·ï¸ Version: ${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "ğŸ”— Links:"
          echo "  - Repository: https://github.com/${{ github.repository }}"
          echo "  - Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
          echo "  - pkg.go.dev: https://pkg.go.dev/github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "ğŸ“¥ Install:"
          echo "  go get github.com/${{ github.repository }}@${{ steps.version.outputs.VERSION }}"
